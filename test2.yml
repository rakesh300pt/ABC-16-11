---
- name: Install Terraform and Git
  hosts: all
  become: yes
  tasks:
    - name: Update the package manager
      apt:
        update_cache: yes
    - name: Install Git
      apt:
        name: git
        state: present
    - name: Ensure the necessary packages are installed (for Ubuntu/Debian systems)
      apt:
        name:
          - unzip
          - wget
        state: present
      become: yes
    - name: Download Terraform
      get_url:
        url: https://releases.hashicorp.com/terraform/1.5.0/terraform_1.5.0_linux_amd64.zip
        dest: /tmp/terraform.zip
    - name: Unzip Terraform binary
      unarchive:
        src: /tmp/terraform.zip
        dest: /usr/local/bin/
        remote_src: yes
    - name: Ensure Terraform binary is executable
      file:
        path: /usr/local/bin/terraform
- name: Ensure the repository is cloned
      git:
        repo: https://github.com/rakesh300pt/Rakesh_Terraform.git
        dest: /home/azureuser/
        version: main
        update: yes
  - name: Ensure Terraform is initialized
      command: terraform init
      args:
        chdir: /home/azureuser
      register: init_output
    - name: Display Terraform init output
      debug:
        msg: /home/azureuser/demo
    - name: Apply Terraform scripts (auto-approve)
      command: terraform apply -auto-approve
      args:
        chdir: /home/azureuser/demo
      register: apply_output
    - name: Display Terraform apply output
      debug:
        msg: "{{ apply_output.stdout }}"
    - name: Capture the output to a file (optional)
      copy:
        content: "{{ apply_output.stdout }}"
        dest: /tmp/terraform_apply_output.txt
    - name: Remove cloned repositories
      file:
        path: /home/azureuser/demo  # Replace with the path of the cloned repository
        state: absent

    - name: Remove specific created files
      file:
        path: /home/azureuser/test.tf  # Replace with the path of the file you want to delete
        state: absent

